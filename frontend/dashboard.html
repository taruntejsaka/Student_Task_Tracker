<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Dashboard - Student Task Tracker</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .progress-container {
      width: 100%;
      background: #ddd;
      border-radius: 8px;
      margin: 15px 0;
      height: 25px;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background: green;
      text-align: center;
      color: white;
      font-weight: bold;
      border-radius: 8px;
      transition: width 0.4s ease;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Task Dashboard</h2>

    <!-- Progress Bar -->
    <div class="progress-container">
      <div id="progressBar" class="progress-bar">0%</div>
    </div>

    <div class="dashboard-controls">
      <label>Status:</label>
      <select id="statusFilter">
        <option value="">All</option>
        <option value="Pending">Pending</option>
        <option value="In Progress">In Progress</option>
        <option value="Completed">Completed</option>
      </select>

      <label>Priority:</label>
      <select id="priorityFilter">
        <option value="">All</option>
        <option value="Low">Low</option>
        <option value="Medium">Medium</option>
        <option value="High">High</option>
      </select>

      <label>Category:</label>
      <input type="text" id="categoryFilter" placeholder="Category" />

      <label>Search:</label>
      <input type="text" id="searchBar" placeholder="Search by title" />

      <label>Sort By:</label>
      <select id="sortBy">
        <option value="dueDate">Due Date</option>
        <option value="priority">Priority</option>
      </select>

      <select id="order">
        <option value="asc">Ascending</option>
        <option value="desc">Descending</option>
      </select>

      <button onclick="window.location.href='createtask.html'">+ Create Task</button>
      <button onclick="loadTasks()">Apply</button>
      <button onclick="logout()">Logout</button>
    </div>

    <table id="taskTable">
      <thead>
        <tr>
          <th>Title</th>
          <th>Status</th>
          <th>Priority</th>
          <th>Category</th>
          <th>Due Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const API = "http://localhost:5001/api/tasks";
    const token = localStorage.getItem("token");

    async function loadTasks() {
      const params = new URLSearchParams({
        status: document.getElementById("statusFilter").value,
        priority: document.getElementById("priorityFilter").value,
        category: document.getElementById("categoryFilter").value,
        search: document.getElementById("searchBar").value,
        sortBy: document.getElementById("sortBy").value,
        order: document.getElementById("order").value
      });

      const res = await fetch(`${API}?${params.toString()}`, {
        headers: { Authorization: "Bearer " + token }
      });

      const tasks = await res.json();
      const tbody = document.querySelector("#taskTable tbody");
      tbody.innerHTML = "";

      let completedCount = 0;

      tasks.forEach(t => {
        if (t.status === "Completed") completedCount++;

        const row = `<tr>
          <td>${t.title}</td>
          <td>
            <select onchange="updateStatus('${t._id}', this.value)">
              <option value="Pending" ${t.status === "Pending" ? "selected" : ""}>Pending</option>
              <option value="In Progress" ${t.status === "In Progress" ? "selected" : ""}>In Progress</option>
              <option value="Completed" ${t.status === "Completed" ? "selected" : ""}>Completed</option>
            </select>
          </td>
          <td>${t.priority}</td>
          <td>${t.category || ""}</td>
          <td>${t.dueDate ? new Date(t.dueDate).toLocaleDateString() : ""}</td>
          <td>
            <button onclick="deleteTask('${t._id}')">Delete</button>
          </td>
        </tr>`;
        tbody.innerHTML += row;
      });

      updateProgressBar(completedCount, tasks.length);
    }

    async function updateStatus(id, newStatus) {
      try {
        const res = await fetch(`${API}/${id}/status`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token
          },
          body: JSON.stringify({ status: newStatus })
        });

        if (!res.ok) {
          const err = await res.json();
          alert("Error updating status: " + (err.message || "Server error"));
        } else {
          loadTasks();
        }
      } catch (error) {
        alert("Error updating status: " + error.message);
      }
    }

    async function deleteTask(id) {
      if (!confirm("Are you sure you want to delete this task?")) return;

      try {
        const res = await fetch(`${API}/${id}`, {
          method: "DELETE",
          headers: { Authorization: "Bearer " + token }
        });

        if (res.ok) {
          alert("Task deleted successfully!");
          loadTasks();
        } else {
          const err = await res.json();
          alert("Error deleting task: " + (err.message || "Server error"));
        }
      } catch (error) {
        alert("Error deleting task: " + error.message);
      }
    }

    function updateProgressBar(completed, total) {
      const percent = total > 0 ? Math.round((completed / total) * 100) : 0;
      const bar = document.getElementById("progressBar");
      bar.style.width = percent + "%";
      bar.textContent = percent + "%";
    }

    async function logout() {
      await fetch("http://localhost:5001/api/auth/logout", {
        method: "POST",
        headers: { Authorization: "Bearer " + token }
      });
      localStorage.clear();
      window.location.href = "login.html";
    }

    loadTasks();
  </script>
</body>
</html>
